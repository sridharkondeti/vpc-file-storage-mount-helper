name: Release

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  release:
    permissions: write-all 
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout Code
      uses: actions/checkout@v2

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2

    - name: Perform CodeQL Analysis Mount Helper Code
      uses: github/codeql-action/analyze@v2

    - name: Report CodeQL Alerts
      id: report-alerts
      run: |
        cnt=$(gh api --jq '.alerts | length' graphql -F owner=$GITHUB_REPOSITORY_OWNER -F repo=$GITHUB_REPOSITORY -F pullRequestNumber=$GITHUB_PR_NUMBER)
        if [ $cnt -gt 0 ]; then
            echo "Alerts Found"
            gh api checks/$GITHUB_CHECK_RUN_ID -X POST -F conclusion=failure -F output.title="Alerts Found" -F output.summary="Alerts Found".
        else
            echo "No Alerts Found"
            gh api checks/$GITHUB_CHECK_RUN_ID -X POST -F conclusion=success -F output.title="No Alerts Found" -F output.summary="No Alerts Found".
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
            
